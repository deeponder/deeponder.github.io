---
layout:     post
title:      redis
subtitle:   
date:       2018-05-19
author:     jabin
header-img: 
catalog: true
tags:
    - 计算机
    - redis
--- 

# 一、什么是redis
1. 开源的，支持网络，基于内存，键值对存储数据库
2. redis默认创建16个数据库，通过select语句可以切换数据库， 即单个实例可以有多个数据库，类似MySQL

# 二、redis底层实现
## 1. 核心对象-redisObject
1. REDIS_STRING: INT, EMBSTR, RAW
2. REDIS_LIST:ZIPLIST(小、连续), LINKEDLIST
3. REDIS_HASH: ZIPLIST(小、连续), HT
4. REDIS_SET:INTSET, HT(key:元素， value: null)
5. REDIS_ZSET: ZIPLIST, SKIPLIST

## 2. 数据结构、编码
1. REDIS_ENCODING_INT: long型整数
2. REDIS_ENCODING_EMBSTR: embstr编码的简单动态字符串
3. REDIS_ENCODING_RAW: 简单动态字符串
4. REDIS_ENCODING_HT: 字典
5. REDIS_ENCODING_LINKEDLIST: 双端链表
6. REDIS_ENCODING_ZIPLIST:压缩链表
7. REDIS_ENCODING_INTSET: 整型集合
8. REDIS_ENCODING_SKIPLIST: 跳跃表和字典

# 三、常用命令
## 1. 进程命令
1. stop: redis-server: kill -9;   
2. restart: /usr/local/bin/redis-server restart /etc/redis/redis.conf
3. 设置密码： config set requirepass qqgame

## 2. 操作命令
1. 可用expire或者pexpire命令，以秒或者毫秒设置某个key的生存时间，到期后服务器会自动删除键
2. TTL命令和PTTL命令返回一个键的生存时间
3. PERSIST可以已出一个键的生存时间
4. 其它基本命令

# 四、过期策略
1. 定时删除： 创建定时器，让定时器来删除 （**redis未采用**）
2. 惰性删除： 获取键时，检查是否过期，过期则删除
3. 定期删除： 每个段时间，程序对数据库进行一次检查，删除过期key

# 五、事务机制（单进程）
1. 将多个执行操作放入queued队列中，exec后再执行
2. 执行时只会检查语法的正确性，不会检查类型或其他
3. exec后，会执行正确的语句，并跳过所有不适当的语句，并且不会回滚

# 六、数据持久化
## 1. 全量策略
即rdb快照，通过配置实现每隔n分钟或者N次写入后从内存dump数据形成rdb文件进行保存到相应目录。
1. 原理：当redis需要做持久化时，redis会fork一个子进程；子进程将数据写到磁盘上一个临时RDB文件中；当子进程完成写临时文件后，将原来的RDB替换掉，这样的好处就是可以copy-on-write
2. 优点：因为存储的快照文件为内存映射，所以恢复快。缺点：断电时会导致部分数据丢失

## 2. 增量策略
aof日志，将执行的命令写入txt文件进行记录
1. 优点：数据不容易丢失。缺点：恢复速度慢

# 七、单线程设计下的分布式实现
## 1. 主从同步
 slave 起来后，向master发同步请求， master将快照给slave， slave通过快照载入数据，以后每次请求， master都发一份给slave
## 2. 实现-tredis
1. 单线程下， 乐观锁、事务等都可以玩。 在一个队列里依次执行，不会产生并发问题
2. 分布式后， 就要考虑分布式锁的各种问题了（乐观锁）， 做了层proxy， 相同的key路由到后端某台redis实例. 所以单key不能过分大， 比如上亿。
## 3. 为何单线程还能这么快
1. 基于内存
2. 数据结构简单
3. 上下文切换
4. 瓶颈可能是内存大小和带宽，不是cpu， 所以就使用单线程了(官方)

